# Askal Mod Test Plan
# For DayZ Community Framework / Community Offline Mode

test_environment:
  server: "DayZ Server with Community Framework"
  client: "DayZ Client"
  mode: "Community Offline Mode (or local test server)"
  
prerequisites:
  - Community Framework installed
  - Askal mod enabled
  - Server admin access
  - Ability to modify player balance via console/admin

test_scenarios:

  - name: "Test 1: Race Condition (Double-Spend)"
    severity: "CRITICAL"
    steps:
      - "1. Start DayZ server with Askal mod"
      - "2. Connect as Player1"
      - "3. Set Player1 balance to 1000 (via admin command or file edit)"
      - "4. Open two terminal windows/scripts"
      - "5. In Window 1: Send RPC PurchaseItemRequest for item costing 500"
      - "6. In Window 2: Immediately send RPC PurchaseItemRequest for item costing 500"
      - "7. Check server logs for balance operations"
      - "8. Check Player1 balance after both operations"
    expected_result: "Only one purchase should succeed. Final balance should be 500."
    actual_result_bug: "Both purchases succeed. Final balance is 500 instead of 0."
    reproduction_script: |
      // Pseudo-code for concurrent RPC test
      // Run these two commands simultaneously:
      GetRPCManager().SendRPC("AskalMarketModule", "PurchaseItemRequest", 
        Param8<string, string, int, string, float, int, int, string>(
          "STEAM_ID", "ItemClass", 500, "Askal_Coin", 1.0, 0, 0, ""
        ), true, NULL, NULL);
      
      // Repeat immediately in second thread/script

  - name: "Test 2: TOCTOU Vulnerability"
    severity: "CRITICAL"
    steps:
      - "1. Start server, connect as Player1"
      - "2. Set Player1 balance to 500"
      - "3. Send PurchaseItemRequest for item costing 1000"
      - "4. Expected: Purchase fails (insufficient balance)"
      - "5. Quickly modify balance file to 1000 (simulate exploit)"
      - "6. Send PurchaseItemRequest again"
      - "7. Check if item was created and balance deducted"
    expected_result: "Purchase should fail OR succeed atomically with item creation"
    actual_result_bug: "Balance deducted but no item created (or vice versa)"
    notes: "This test requires manual file modification or admin command"

  - name: "Test 3: Batch Purchase Partial Failure"
    severity: "HIGH"
    steps:
      - "1. Start server, connect as Player1"
      - "2. Set Player1 balance to 400"
      - "3. Create batch request: [Item1: 100, Item2: 200, Item3: 300]"
      - "4. Send PurchaseBatchRequest"
      - "5. Check which items were created"
      - "6. Check final balance"
    expected_result: "All purchases should fail (insufficient balance for batch)"
    actual_result_bug: "First 2 items succeed, 3rd fails. Balance = 100 (should be 400)"
    reproduction_command: |
      // Batch purchase with insufficient balance
      array<ref AskalPurchaseRequestData> batch = new array<ref AskalPurchaseRequestData>();
      batch.Insert(new AskalPurchaseRequestData("Item1", 100, 1.0, 0, 0));
      batch.Insert(new AskalPurchaseRequestData("Item2", 200, 1.0, 0, 0));
      batch.Insert(new AskalPurchaseRequestData("Item3", 300, 1.0, 0, 0));
      
      Param3<string, string, ref array<ref AskalPurchaseRequestData>> params = 
        new Param3<string, string, ref array<ref AskalPurchaseRequestData>>(
          "STEAM_ID", "Askal_Coin", batch
        );
      
      GetRPCManager().SendRPC("AskalMarketModule", "PurchaseBatchRequest", params, true, NULL, NULL);

  - name: "Test 4: Rate Limiting"
    severity: "HIGH"
    steps:
      - "1. Start server, connect as Player1"
      - "2. Set Player1 balance to 10000"
      - "3. Send 20 PurchaseItemRequest RPCs in rapid succession (< 1 second)"
      - "4. Check server logs for rate limit messages"
      - "5. Count successful purchases"
    expected_result: "Only 5 purchases should succeed. Rest should be rate-limited."
    actual_result_bug: "All 20 purchases succeed (DoS possible)"
    reproduction_script: |
      // Spam purchase requests
      for (int i = 0; i < 20; i++)
      {
        GetRPCManager().SendRPC("AskalMarketModule", "PurchaseItemRequest", 
          Param8<string, string, int, string, float, int, int, string>(
            "STEAM_ID", "ItemClass", 100, "Askal_Coin", 1.0, 0, 0, ""
          ), true, NULL, NULL);
      }

  - name: "Test 5: Crash Recovery"
    severity: "MEDIUM"
    steps:
      - "1. Start server, connect as Player1"
      - "2. Set Player1 balance to 1000"
      - "3. Make a purchase (balance should become 500)"
      - "4. Immediately kill server process (simulate crash)"
      - "5. Check player JSON file: $profile:Askal/Database/Players/STEAM_ID.json"
      - "6. Restart server"
      - "7. Check Player1 balance"
    expected_result: "Balance should be 500 (transaction persisted)"
    actual_result_bug: "Balance may be 1000 (transaction lost - no flush)"
    notes: "Requires server process kill during transaction"

  - name: "Test 6: Concurrent Purchases from Same Player"
    severity: "CRITICAL"
    steps:
      - "1. Start server, connect as Player1"
      - "2. Set Player1 balance to 1000"
      - "3. Open store menu"
      - "4. Rapidly click 'Buy' button 5 times for same item (cost: 300)"
      - "5. Check how many items were created"
      - "6. Check final balance"
    expected_result: "Only 3 items should be created. Balance = 100."
    actual_result_bug: "5 items created. Balance = -500 (negative balance possible)"

  - name: "Test 7: Sell Item with Cargo"
    severity: "MEDIUM"
    steps:
      - "1. Start server, connect as Player1"
      - "2. Get container item (e.g., backpack)"
      - "3. Put items inside container"
      - "4. Try to sell container"
    expected_result: "Sell should fail (item has cargo)"
    actual_result: "Should work correctly (has validation)"

  - name: "Test 8: Batch Size Limit"
    severity: "LOW"
    steps:
      - "1. Start server, connect as Player1"
      - "2. Set Player1 balance to 100000"
      - "3. Create batch with 100 items"
      - "4. Send PurchaseBatchRequest"
    expected_result: "Batch should be rejected (size > MAX_BATCH_SIZE)"
    actual_result_bug: "All 100 items processed (server overload)"

  - name: "Test 9: Performance Under Load"
    severity: "MEDIUM"
    steps:
      - "1. Start server"
      - "2. Connect 10 players"
      - "3. Each player makes 10 purchases/second"
      - "4. Monitor server FPS/performance"
      - "5. Check file I/O operations in logs"
    expected_result: "Server should maintain > 30 FPS"
    actual_result_bug: "Server FPS drops to < 10 FPS (synchronous I/O bottleneck)"

  - name: "Test 10: Schema Migration"
    severity: "LOW"
    steps:
      - "1. Create old-format player JSON (without SchemaVersion)"
      - "2. Start server"
      - "3. Player connects"
      - "4. Check if player data loads correctly"
    expected_result: "Player data should migrate to new schema"
    actual_result_bug: "Player data may fail to load or corrupt"

# Community Offline Mode Setup
offline_mode_setup:
  - "1. Enable Community Offline Mode in DayZ launcher"
  - "2. Load Askal mod"
  - "3. Start game"
  - "4. Press ESC → Mods → Enable Askal"
  - "5. Create new character"
  - "6. Open console with F2 (or configured key)"
  - "7. Use admin commands to modify balance (if available)"

# Admin Commands (if available)
admin_commands:
  - "SetBalance STEAM_ID 1000"
  - "AddBalance STEAM_ID 500"
  - "RemoveBalance STEAM_ID 200"

# Manual File Editing (for testing)
file_editing:
  balance_file: "$profile:Askal/Database/Players/STEAM_ID.json"
  format: |
    {
      "FirstLogin": "0",
      "Balance": {
        "Askal_Coin": 1000
      },
      "CreditCard": 0,
      "PremiumStatusExpireInHours": 0,
      "Permissions": {}
    }

# Log Monitoring
log_files:
  server_log: "$profile:Askal/Logs/server.log"
  balance_log: "Look for '[AskalBalance]' entries"
  purchase_log: "Look for '[AskalPurchase]' entries"

# Success Criteria
success_criteria:
  - "No double-spend occurs"
  - "All transactions are atomic"
  - "Rate limiting prevents DoS"
  - "Batch operations are atomic"
  - "No data loss on crash"
  - "Server maintains > 30 FPS under load"

